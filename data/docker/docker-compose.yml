version: "3.8"
services:
  fastapi-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
    ports:
      - "8000:8000"
    environment:
      FAST_API_HOST: "0.0.0.0"
      FAST_API_PORT: "8000"
      API_SERVICE_KEY: "rLaFwLttDBK/4TJGl5YTyqxv8ApckaQ36upAZrhp1UW1PErafSdXcCCK2KKHPU1UiaNCPIp2y3azBiJom7D5nw=="
      KAFKA_BROKER: "kafka:9092"
      KAFKA_BULK_TOPIC: "lostfund_bulk"
      KAFKA_DETAIL_TOPIC: "lostfund_detail"
      DB_HOST: "mysql"
      DB_PORT: "3306"
      DB_USER: "root"
      DB_PASSWORD: "password"
      DB_NAME: "lostfound"
      S3_ENDPOINT_URL: "http://minio:9000"
      AWS_ACCESS_KEY: "minioadmin"
      AWS_SECRET_KEY: "minioadmin"
      AWS_REGION: "us-east-1"
      AWS_S3_BUCKET: "my-bucket"
      ES_HOST: "elasticsearch"
      ES_PORT: "9200"
      ES_INDEX: "found_items"
    depends_on:
      - kafka
      - mysql
      - minio
      - elasticsearch

  spark-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.spark
    environment:
      KAFKA_BROKER: "kafka:9092"
      KAFKA_BULK_TOPIC: "lostfund_bulk"
      KAFKA_DETAIL_TOPIC: "lostfund_detail"
      DB_HOST: "mysql"
      DB_PORT: "3306"
      DB_USER: "root"
      DB_PASSWORD: "password"
      DB_NAME: "lostfound"
      S3_ENDPOINT_URL: "http://minio:9000"
      AWS_ACCESS_KEY: "minioadmin"
      AWS_SECRET_KEY: "minioadmin"
      AWS_REGION: "us-east-1"
      AWS_S3_BUCKET: "my-bucket"
      ES_HOST: "elasticsearch"
      ES_PORT: "9200"
      ES_INDEX: "found_items"
      HADOOP_NAMENODE_HOST: "hadoop-namenode"
      HADOOP_NAMENODE_PORT: "9000"
    depends_on:
      - kafka
      - mysql
      - minio
      - elasticsearch
      - hadoop-namenode
    restart: always

  # 최신 OCI 형식을 지원하는 Zookeeper 이미지로 교체
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: wurstmeister/kafka:2.12-2.2.1
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper


  mysql:
    image: mysql:5.7
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: "password"
      MYSQL_DATABASE: "lostfound"
    volumes:
      - mysql_data:/var/lib/mysql

  minio:
    image: minio/minio:latest
    ports:
      - "9001:9000"
    environment:
      MINIO_ACCESS_KEY: "minioadmin"
      MINIO_SECRET_KEY: "minioadmin"
    command: server /data
    volumes:
      - minio_data:/data

  elasticsearch:
    image: elasticsearch:7.17.0
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data

  hadoop-namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop2.7.4-java8
    environment:
      CLUSTER_NAME: "local-hadoop"
    ports:
      - "9000:9000"
    volumes:
      - hadoop_data:/hadoop/dfs/name

  hadoop-datanode:
    image: bde2020/hadoop-datanode:2.0.0-hadoop2.7.4-java8
    environment:
      CORE_CONF_fs_defaultFS: "hdfs://hadoop-namenode:9000"
    depends_on:
      - hadoop-namenode
    volumes:
      - hadoop_data:/hadoop/dfs/data

volumes:
  mysql_data:
  minio_data:
  es_data:
  hadoop_data:
